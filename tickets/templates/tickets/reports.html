{% extends "base_generic.html" %}

{% block page_title %}Аналитика{% endblock %}
{% block page_subtitle %}Статистика и отчёты по заявкам ООО Мирмекс{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

<!-- Summary cards -->
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
    <div class="stat-card stat-in-progress">
        <div class="stat-icon"><i class="bi bi-ticket"></i></div>
        <div class="stat-value">{{ total }}</div>
        <div class="stat-label">Всего заявок</div>
    </div>
    <div class="stat-card stat-new">
        <div class="stat-icon"><i class="bi bi-folder2-open"></i></div>
        <div class="stat-value">{{ open_count }}</div>
        <div class="stat-label">Открытых</div>
    </div>
    <div class="stat-card stat-closed">
        <div class="stat-icon"><i class="bi bi-check-all"></i></div>
        <div class="stat-value">{{ closed_total }}</div>
        <div class="stat-label">Закрытых</div>
    </div>
    <div class="stat-card stat-assigned">
        <div class="stat-icon"><i class="bi bi-calendar-month"></i></div>
        <div class="stat-value">{{ created_month }}</div>
        <div class="stat-label">Создано за месяц</div>
    </div>
    <div class="stat-card stat-closed">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-value">{{ closed_month }}</div>
        <div class="stat-label">Закрыто за месяц</div>
    </div>
    <div class="stat-card stat-new">
        <div class="stat-icon"><i class="bi bi-alarm"></i></div>
        <div class="stat-value">{{ overdue_count }}</div>
        <div class="stat-label">Просрочено</div>
    </div>
    <div class="stat-card stat-in-progress">
        <div class="stat-icon"><i class="bi bi-stopwatch"></i></div>
        <div class="stat-value">
            {% if avg_resolution_hours %}{{ avg_resolution_hours }}ч{% else %}—{% endif %}
        </div>
        <div class="stat-label">Среднее время решения</div>
    </div>
</div>

<!-- Charts row 1: trend + status -->
<div class="row mb-3">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Поток заявок за последние 30 дней
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="90"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-pie-chart"></i> По статусам
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="statusChart" style="max-height:220px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts row 2: category + priority -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-tags"></i> По категориям
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="categoryChart" style="max-height:240px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-flag"></i> По приоритетам
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="priorityChart" style="max-height:240px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Technician stats -->
<div class="card mb-3">
    <div class="card-header">
        <i class="bi bi-people"></i> Нагрузка на техников
    </div>
    <div class="card-body p-0">
        {% if tech_stats %}
        <div class="table-responsive">
            <table class="table table-sm mb-0" style="font-size:0.88rem;">
                <thead class="table-light">
                    <tr>
                        <th>Техник</th>
                        <th class="text-center">Всего</th>
                        <th class="text-center">Открытых</th>
                        <th class="text-center">Закрытых</th>
                        <th class="text-center">Среднее время</th>
                        <th>Загрузка</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tech_stats %}
                    <tr>
                        <td>
                            <i class="bi bi-person-circle text-orange"></i>
                            {{ t.full_name }}
                        </td>
                        <td class="text-center"><strong>{{ t.total }}</strong></td>
                        <td class="text-center">
                            {% if t.open > 0 %}
                            <span class="badge bg-warning text-dark">{{ t.open }}</span>
                            {% else %}
                            <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-success">{{ t.closed }}</span>
                        </td>
                        <td class="text-center">
                            {% if t.avg_hours %}{{ t.avg_hours }} ч.{% else %}<span class="text-muted">—</span>{% endif %}
                        </td>
                        <td style="min-width:120px;">
                            {% if t.total > 0 %}
                            {% widthratio t.open t.total 100 as open_pct %}
                            <div class="progress" style="height:6px; border-radius:3px;">
                                <div class="progress-bar bg-warning" style="width:{{ open_pct }}%"></div>
                            </div>
                            <small class="text-muted">{{ open_pct }}% открытых</small>
                            {% else %}
                            <small class="text-muted">Нет заявок</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state py-3">
            <i class="bi bi-people"></i>
            <p>Техников не найдено</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent activity -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-clock-history"></i> Последние действия
    </div>
    <div class="card-body p-0">
        {% if recent_history %}
        <div class="table-responsive">
            <table class="table table-sm mb-0" style="font-size:0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th>Заявка</th>
                        <th>Действие</th>
                        <th>Описание</th>
                        <th>Пользователь</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in recent_history %}
                    <tr>
                        <td>
                            <a href="{% url 'ticket_detail' h.ticket.pk %}" class="text-decoration-none text-orange">
                                #{{ h.ticket.pk }}
                            </a>
                        </td>
                        <td>
                            <span class="badge
                                {% if h.action == 'created' %}bg-success
                                {% elif h.action == 'status_changed' %}bg-primary
                                {% elif h.action == 'assigned' %}bg-warning text-dark
                                {% elif h.action == 'commented' %}bg-secondary
                                {% else %}bg-info text-dark{% endif %}">
                                {{ h.get_action_display }}
                            </span>
                        </td>
                        <td class="text-muted">{{ h.comment|truncatechars:50 }}</td>
                        <td>{% if h.changed_by %}{{ h.changed_by.get_full_name|default:h.changed_by.username }}{% else %}—{% endif %}</td>
                        <td class="text-muted">{{ h.timestamp|date:"d.m.Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state py-3">
            <i class="bi bi-clock"></i>
            <p>Действий пока нет</p>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const statusData   = {{ status_data|safe }};
const categoryData = {{ category_data|safe }};
const priorityData = {{ priority_data|safe }};
const trendData    = {{ trend_data|safe }};

// Trend chart
new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
        labels: trendData.labels,
        datasets: [{
            label: 'Заявок создано',
            data: trendData.values,
            borderColor: '#FF6600',
            backgroundColor: 'rgba(255,102,0,0.08)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: '#FF6600',
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
            x: { ticks: { maxTicksLimit: 10 } }
        }
    }
});

// Status doughnut
new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: statusData.labels,
        datasets: [{ data: statusData.values, backgroundColor: statusData.colors, borderWidth: 2 }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10 } }
        },
        cutout: '60%'
    }
});

// Category bar
new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
        labels: categoryData.labels,
        datasets: [{
            label: 'Заявок',
            data: categoryData.values,
            backgroundColor: categoryData.colors,
            borderRadius: 5,
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
});

// Priority doughnut
new Chart(document.getElementById('priorityChart'), {
    type: 'doughnut',
    data: {
        labels: priorityData.labels,
        datasets: [{ data: priorityData.values, backgroundColor: priorityData.colors, borderWidth: 2 }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10 } }
        },
        cutout: '60%'
    }
});
</script>
{% endblock %}
